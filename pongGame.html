<!--

TO DO:
- more balls?
- add marker with html - goal count
- add authors on bottom
- keybind to accelarate / slow down ball
- colour explosion? etc
- add instructions - keybinds, etc to html on bottom
- select right or left player

TO FIX:
- can't detect second key being pushed when another one has been pushed first
- ball disappears when resetting turn every few resets (more often when thrown to left side) - counts as score, ball disappears - a veces ball.movementY da undefined
- angle ball throwing - ball movement is linear when hit by the player, no matter the angle or where it got hit

SUGGESTIONS:
- if ball hits a corner, ball speed increases greatly
- if ball hits angle, ball speed incresase ??
- time over ??
- speed increases over time ??
- 3p?
- mode: noob, easy, medium, hard, impossible
- pause?

-->

<!doctype html>
<html>

<!-- STEP 1: Prepare the canvas -->

<head>
    <style>
        #my_Canvas {
            border: 5px dotted red;
            padding-left: 0;
            padding-right: 0;
            margin: auto;
            display: block;
            border-radius: 15px;
            background-color: grey;
            margin-top: 5%;
        }

        #overlay {
            position: fixed;
            display: block;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        #text {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 50px;
            color: white;
            transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
        }

        #scoreboard3,
        #scoreboard4 {
            display: hidden;
        }
    </style>
</head>

<body>
    <div id="overlay">
        <div id="menu-container">
            <div id="text">Pong</div>
            <button id="singlePlayer" onclick="pongGame.play('single')">Single player</button>
            <button id="singlePlayer" onclick="pongGame.play('multi')">Multiplayer</button>
            <button id="singlePlayer" onclick="pongGame.play('3p')">3p</button>
            <button id="singlePlayer" onclick="pongGame.play('4p')">4p</button>
            <button id="singlePlayer" onclick="pongGame.closeMenu()">Options</button>
            <button id="singlePlayer" onclick="pongGame.closeMenu()">Instrutions</button>
        </div>
    </div>

    <div id="container">
        <div id="scoreboard">
            <div id="scoreboard1">1 ---> 0</div>
            <div id="scoreboard2">2 ---> 0</div>
            <div id="scoreboard3">3 ---> 0</div>
            <div id="scoreboard4">4 ---> 0</div>
        </div>
        <canvas width="600" height="550" id="my_Canvas"></canvas>

        <!-- <p>
            Instructions:
            - Player 1 Up: || Down:
             -> ↑ ↓
            - Plyer 2 Up: w || Down: s
        </p> -->
    </div>

    <!-- vertex Shader -->
    <script id="vertex-shader" type="x-shader/x-vertex">
       #version 300 es
       precision mediump float;

       in vec2 aCoordinates;

       void main(void) {
         gl_Position = vec4(aCoordinates, 0, 1);
         gl_PointSize = 10.0;
       }

  </script>


    <!-- fragment Shader -->
    <script id="fragment-shader" type="x-shader/x-fragment">
      #version 300 es
      precision mediump float;

      uniform vec4 uColor;

      out vec4 fragColor;

      void main(void) {
        fragColor = uColor;
    }
  </script>

    <script>

        // Basic variables
        var colorLoc;
        var vertexBuffer;
        var goals = [1, 3, 5, 10]; // Goals per game
        var ended; // Determines if a game has finished or not

        // Game direction - ball & player movement
        var direction = {
            'standard': 0,
            // 'left': -0.03, 'right': 0.03,
            'left': -0.015, 'right': 0.015,
            'up': 0.01, 'down': -0.01
        }

        // Game modes - increments ball speed, player speed, player size, ball size, more balls, etc
        // var noob = {
        //     'ballSpeed': 0.01,
        //     'playerSpeed': 0,
        //     'playerHeight': 0,
        //     'ballSize': 0,
        //     'balls': 1
        // }

        // var easy = {
        //     'ballSpeed': 0.01,
        //     'playerSpeed': 0,
        //     'playerHeight': 0,
        //     'ballSize': 0,
        //     'balls': 1
        // }

        // var medium = {
        //     'ballSpeed': 0.01,
        //     'playerSpeed': 0,
        //     'playerHeight': 0,
        //     'ballSize': 0,
        //     'balls': 1
        // }

        // var hard = {
        //     'ballSpeed': 0.01,
        //     'playerSpeed': 0,
        //     'playerHeight': 0,
        //     'ballSize': 0,
        //     'balls': 1
        // }

        // var extreme = {
        //     'ballSpeed': 0.01,
        //     'playerSpeed': 0,
        //     'playerHeight': 0,
        //     'ballSize': 0,
        //     'balls': 1
        // }

        // Ball
        var ball = {
            'x': 0, 'y': 0,
            'width': 0.05, 'height': 0.05,
            'color': [1, 1, 0, 1],
            'movementX': 0.015, 'movementY': 0.01,
            'hit': 0 // 0 -> none; 1 -> player1; 2-> player2; 3 -> player3; 4 -> player4
        }

        // ---------------------------------------- Modified in class ----------------------------------------
        //      var ball = {
        //        'x':-0.5, 'y':0.3,
        //        'width':0.1, 'height':0.1,
        //        'color':[1,1,0,1],
        //        'speedX':0.01, 'speedY':-0.02
        //      }

        // var player1 = {
        //   'x':-0.8, 'y':-0.3,
        //   'width':0.1, 'height':0.4,
        //   'color':[1,1,1,1],
        //   'move':0 // -1 -> moving down; 0 -> static; 1 -> moving up
        // }

        //      var player2 = {
        //        'x':0.7, 'y':-0.3,
        //        'width':0.1, 'height':0.4,
        //        'color':[1,1,1,1],
        //        'move':0 // -1 -> moving down; 0 -> static; 1 -> moving up
        //      }

        function drawRectangle(r) {
            x = r.x;
            y = r.y;
            w = r.width;
            h = r.height;
            v = new Float32Array([x, y + h, x + w, y + h, x, y,
                x, y, x + w, y + h, x + w, y]);
            // Pass the vertex data to the buffer
            gl.bufferData(gl.ARRAY_BUFFER, v, gl.STATIC_DRAW);
            gl.uniform4fv(colorLoc, r.color); // We add the v because it's a vector
            gl.drawArrays(gl.TRIANGLES, 0, 6); // Method that paints elements - rectangles, etc
        }
        // ---------------------------------------- End class modification ----------------------------------------

        // Checking for collisions
        function isColliding(pl1, pl2) {
            smallerWidth = pl1.x < pl2.x + pl2.width;
            biggerWidth = pl1.x + pl1.width > pl2.x;
            smallerHeight = pl1.y < pl2.y + pl2.height;
            biggerHeight = pl1.y + pl1.height > pl2.y;

            return smallerWidth && biggerWidth && smallerHeight && biggerHeight;
        }

        function init(gameType, goalNum) {
            // Game initialization
            this.gameType = gameType;
            this.goalNum = goalNum;
            player1 = pongGame.newPlayer(-0.8, -0.15, "player1", 0.05, 0.3); // Left player
            player2 = pongGame.newPlayer(0.74, -0.15, "player2", 0.05, 0.3); // Right player
            player3 = pongGame.newPlayer(-0.15, 0.73, "player3", 0.3, 0.05); // Top player || x = (width / 2) * -1
            player4 = pongGame.newPlayer(-0.15, -0.78, "player4", 0.3, 0.05); // Bottom player
            player5 = pongGame.newPlayer(0, 0, "player5", 0, 0); // Phantom player - avoid error among first goal without a player hit (4 players)

            // ============ STEP 1: Creating a canvas=================
            canvas = document.getElementById('my_Canvas');
            gl = canvas.getContext('webgl2');

            //======= STEP 2: Defining and storing the geometry=======
            var vertices = [
                -0.8, 0.5,
                0.0, 0.5,
                -0.25, 0.25,
                0.0, 0.0
            ];

            // Create an empty buffer object to store the vertex buffer
            vertex_buffer = gl.createBuffer();

            // Bind appropriate array buffer to it
            gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);

            // Unbind the buffer
            gl.bindBuffer(gl.ARRAY_BUFFER, null);

            //========== STEP 3: Create and compile shaders ==========

            // Create a vertex shader object
            var vertShader = gl.createShader(gl.VERTEX_SHADER);

            // Attach vertex shader source code
            var script = document.getElementById('vertex-shader');
            var shaderString = script.text.trim();
            gl.shaderSource(vertShader, shaderString);

            // Compile the vertex shader
            gl.compileShader(vertShader);

            // Create fragment shader object
            var fragShader = gl.createShader(gl.FRAGMENT_SHADER);

            // Attach fragment shader source code
            script = document.getElementById('fragment-shader');
            shaderString = script.text.trim();
            gl.shaderSource(fragShader, shaderString);

            // Compile the fragmentt shader
            gl.compileShader(fragShader);

            // Create a shader program object to store the combined shader program
            var shaderProgram = gl.createProgram();

            // Attach a vertex shader
            gl.attachShader(shaderProgram, vertShader);

            // Attach a fragment shader
            gl.attachShader(shaderProgram, fragShader);

            // Link both programs
            gl.linkProgram(shaderProgram);

            // Use the combined shader program object
            gl.useProgram(shaderProgram);

            //======== STEP 4: Associating shaders to buffer objects ========

            // Bind vertex buffer object
            gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);

            // Get the attribute location
            var coordLocation = gl.getAttribLocation(shaderProgram, "aCoordinates");

            // obtener la location del color
            colorLoc = gl.getUniformLocation(shaderProgram, "uColor");

            // Point an attribute to the currently bound VBO
            gl.vertexAttribPointer(coordLocation, 2, gl.FLOAT, false, 0, 0);

            // Enable the attribute
            gl.enableVertexAttribArray(coordLocation);

            // Unbind the buffer
            gl.bindBuffer(gl.ARRAY_BUFFER, null);

            time = 0;
            count = 0;
            pongGame.render(time);

            // Recognizing keyboard
            document.onkeydown = pongGame.onKeyDown;
            document.onkeyup = pongGame.onKeyUp;
        }

        // ############################# MENUS #############################

        function gameEndMenu() { }

        // ############################# RENDERING #############################

        var game = {
            render: function (time) {
                count += 1;
                // console.log('tiempo='+time);

                //========= STEP 5: Drawing the primitive ===============

                // Clear the canvas - r, g, b, a
                gl.clearColor(0, 0, 0, 1.0);

                // Clear the color buffer bit
                gl.clear(gl.COLOR_BUFFER_BIT);

                // Set the view port
                gl.viewport(0, 0, canvas.width, canvas.height);

                gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);

                // Updates all objects - score, players & ball movement
                pongGame.drawObjects(); // Draw objects - players & ball
                pongGame.ballCollisions(); // Limiting ball to canvas

                // Animating players
                if (this.gameType === "single") {
                    pongGame.playerAnimation(player1);
                    pongGame.aiAnimation();
                } else if (this.gameType === "multi") {
                    pongGame.playerAnimation(player1);
                    pongGame.playerAnimation(player2);
                } else if (this.gameType === "3p") {
                    pongGame.playerAnimation(player1);
                    pongGame.playerAnimation(player2);
                    pongGame.playerAnimation(player3);
                } else {
                    pongGame.playerAnimation(player1);
                    pongGame.playerAnimation(player2);
                    pongGame.playerAnimation(player3);
                    pongGame.playerAnimation(player4);
                }

                // Ball speed is randomly increased - since there's no ball speed but movementX, speed
                // cannot be increased gradually (movementX varies upon reset or hit)
                // Being randomly increased ensures a non-boring game and avoids linear hits vs AI
                if (count > 0 && count % 10 == 0) {
                    if (ball.movementX < 0) ball.movementX -= 0.003;
                    else ball.movementX += 0.003;
                }

                pongGame.ballAnimation(); // Ball animation
                pongGame.playerCollisions(); // Player collision limit - ball & wall

                gl.bindBuffer(gl.ARRAY_BUFFER, null);

                if (ended === false) {
                    window.requestAnimationFrame(pongGame.render); // Comment it to avoid animation
                }
            },

            // ############################# GAME OBJECTS #############################

            drawObjects: function () {
                drawRectangle(ball); // Painting the ball
                drawRectangle(player1); // Painting player1
                drawRectangle(player2); // Painting player2

                if (gameType === "3p") drawRectangle(player3);
                else if (gameType === "4p") {
                    drawRectangle(player3);
                    drawRectangle(player4);
                }
            },

            newPlayer: function (x, y, playerName, width, height) {
                var playerName = { // Bottom player
                    'x': x, 'y': y,
                    'width': width, 'height': height,
                    'color': [1, 1, 1, 1],
                    'move': 0, // -1 -> moving down; 0 -> static; 1 -> moving up
                    'score': 0
                }

                return playerName;
            },

            // ############################# ANIMATIONS & COLLISIONS #############################

            ballAnimation: function () {
                ball.x += ball.movementX; // Si pongo aqui el pongGame.getRandomOption(); la pelota se mueve en zig zag - posible minijuego??
                ball.y += ball.movementY;
            },

            playerAnimation: function (playerName) {
                if (playerName == player1 || playerName == player2) playerName.y += playerName.move;
                else playerName.x += playerName.move;
            },

            aiAnimation: function () {
                // AI moves up
                if (player2.y > ball.y - (player2.height / 2)) {
                    if (ball.movementX > 0) player2.y -= 0.008;
                    else player2.y -= 0.008;
                }
                // AI moves down
                if (player2.y < ball.y - (player2.height / 2)) {
                    if (ball.movementX > 0) player2.y += 0.008; // 0.008 noob - 0.01 no falla
                    else player2.y += 0.008;
                }
            },

            playerCollisions: function () {
                // Ball & player collisions
                if (gameType == "single" || gameType == "multi") {
                    pongGame.playerCollisionsRightLeft();
                } else {
                    pongGame.playerCollisionsRightLeft();
                    pongGame.playerCollisionsTopBottom();
                }

                // Player canvas limit
                if (gameType == "single" || gameType == "multi") {
                    pongGame.playerCanvasCollisionsTopBottom(player1, 1, -1);
                    pongGame.playerCanvasCollisionsTopBottom(player2, 1, -1);
                } else {
                    pongGame.playerCanvasCollisionsTopBottom(player1, 0.78, -0.73);
                    pongGame.playerCanvasCollisionsTopBottom(player2, 0.78, -0.73);
                    pongGame.playerCanvasCollisionsRightLeft(player3, -0.75, 0.79);
                    pongGame.playerCanvasCollisionsRightLeft(player4, -0.75, 0.79);
                }
            },

            ballCollisions: function () {
                switch (ball.hit) {
                    case 0: winner = player5; break;
                    case 1: winner = player1; break;
                    case 2: winner = player2; break;
                    case 3: winner = player3; break;
                    case 4: winner = player4; break;
                };

                if (gameType == "single" || gameType == "multi") {
                    pongGame.borderBounceTopBottom();
                    pongGame.borderResetLeftRight(winner);
                } else {
                    pongGame.borderResetLeftRight(winner);
                    pongGame.borderResetTopBottom(winner);
                }

                // Top & bottom bounce
                // if (ball.x <= -1) ball.movementX *= -1; // Left border
                // if (ball.x + ball.width >= 1) ball.movementX *= -1; // Right border
            },

            playerCollisionsRightLeft: function () {
                if (ball.x < 0.749 && ball.x > (player2.x - player2.width) - 0.01) { // Right player
                    if (ball.y <= player2.y + player2.height && ball.y + ball.height >= player2.y) {
                        ball.x = (player2.x - ball.width);
                        ball.movementX = direction.left;
                        ball.hit = 2;
                    }
                }
                if (ball.x < -0.749 && ball.x > (player1.x - player1.width) + 0.01) { // Left player
                    if (ball.y <= player1.y + player1.height && ball.y + ball.height >= player1.y) {
                        ball.x = (player1.x + ball.width);
                        ball.movementX = direction.right;
                        ball.hit = 1;
                    }
                }
            },

            playerCollisionsTopBottom: function () {
                if (ball.y < 0.749 && ball.y > (player3.y - player3.height) - 0.01) { // Top player
                    if (ball.x <= player3.x + player3.width && ball.x + ball.width >= player3.x) {
                        ball.y = (player3.y - ball.height);
                        ball.movementY = direction.down;
                        ball.hit = 3;
                    }
                }
                if (ball.y < -0.749 && ball.y > (player4.y - player4.height) + 0.01) { // Bottom player
                    if (ball.x <= player4.x + player4.width && ball.x + ball.width >= player4.x) {
                        ball.y = (player4.y + ball.height);
                        ball.movementY = direction.up;
                        ball.hit = 4;
                    }
                }
            },

            playerCanvasCollisionsTopBottom: function (playerName, topValue, bottomValue) {
                if (playerName.y >= (topValue - playerName.height)) playerName.y = (topValue - playerName.height); // Top limit
                if (playerName.y <= bottomValue) playerName.y = bottomValue; // Bottom limit
            },

            playerCanvasCollisionsRightLeft: function (playerName, leftValue, rightValue) {
                if (playerName.x >= (rightValue - playerName.width)) playerName.x = (rightValue - playerName.width); // Left limit
                if (playerName.x <= leftValue) playerName.x = leftValue; // Right limit
            },

            borderResetLeftRight: function (winner) {
                if (ball.x <= -1) pongGame.newTurn(winner, player1); // Left border reset
                if (ball.x + ball.width >= 1) pongGame.newTurn(winner, player2); // Right border reset
            },

            borderResetTopBottom: function (winner) {
                if (ball.y <= -1) pongGame.newTurn(winner, player4); // Bottom border reset
                if (ball.y + ball.height >= 1) pongGame.newTurn(winner, player3); // Top border reset
            },

            borderBounceTopBottom: function () {
                if (ball.y + ball.width >= 1) ball.movementY *= -1; // Top border bounce
                if (ball.y <= -1) ball.movementY *= -1; // Bottom border bounce
            },

            // ############################# KEYBOARD DETECTING #############################

            // Processing keyDown through flag
            onKeyDown: function (key) {
                switch (key.keyCode) { // Player state changes to moving up or down by key pressing
                    case 87: player1.move = 0.02; break; // Keybind w - up
                    case 83: player1.move = -0.02; break; // Keybind s - down
                    case 38: player2.move = 0.02; break; // Arrow up
                    case 40: player2.move = -0.02; break; // Arrow down
                    case 74: player3.move = -0.02; break; // Keybind j - left
                    case 76: player3.move = 0.02; break; // Keybind l - right
                    case 100: player4.move = -0.02; break; // Keybind 4 (numlock) - left
                    case 102: player4.move = 0.02; break; // Keybind 6 (numlock) - right
                }
            },

            // Processing keyUp through flag
            onKeyUp: function (key) {
                player1.move = 0;
                player2.move = 0;
                player3.move = 0;
                player4.move = 0;
            },

            // ############################# GAME DEVELOPMENT #############################

            // Start game
            play: function (type) {
                pongGame.closeMenu();
                ended = false;
                init(type, 2);
            },

            // Resets turn when ball is thrown out of the canvas
            newTurn: function (winner, loser) {
                // Reset ball values
                ball.x = 0;
                ball.y = 0;

                // Ball is redirected to loser's side
                if (loser == player2) {
                    // AQUI EL PROBLEMA
                }



                if (gameType == "single" || gameType == "multi") {
                    if (loser == player2) {
                        pongGame.newTurnAux(winner, direction.right, 0.015, -0.015, 'scoreboard1');
                    } else if (loser == player1) {
                        pongGame.newTurnAux(winner, direction.left, 0.014, -0.015, 'scoreboard2');
                    }
                } else if (gameType == "3p") {

                } else if (gameType == "4p") {
                    if (winner == player1) {
                        pongGame.newTurnAux(winner, direction.right, 0.015, -0.015, 'scoreboard1');
                    }
                }
                // else if (loser == player3) {
                //     pongGame.newTurnAux(winner, direction.up, 0.014, -0.015, 'scoreboard3');
                // } else if (loser == player4) {
                //     pongGame.newTurnAux(winner, direction.down, 0.015, -0.015, 'scoreboard4');
                // }
            },

            // Auxiliar function for newTurn - updates ball movement & scoreboard
            newTurnAux: function (winner, dir, float1, float2, scoreboard) {
                ball.movementX = dir;
                ball.movementY = pongGame.getRandomFloat(float1, float2)

                pongGame.updateScoreboard(scoreboard, winner); // Update score
            },

            // ############################# SCOREBOARD #############################

            // Update scoreboard
            updateScoreboard: function (playerScoreboard, player) {
                player.score += 1;
                var count = document.getElementById(playerScoreboard).innerHTML = player.score;

                pongGame.clearScoreboard();
            },

            // Clear scoreboard upong ending game
            clearScoreboard: function () {
                if (player1.score == 15 || player2.score == 15) {
                    ended = true;
                    document.getElementById("overlay").style.display = "block";
                    document.getElementById('scoreboard1').innerHTML = document.getElementById('scoreboard2').innerHTML = 0;
                    player1.score = player2.score = 0; // Restart scoreboard
                    ball.movementX = pongGame.getRandomOption(); // Ball moves towards random player
                }
            },

            // ############################# TOOLS #############################

            // Close overlay
            closeMenu: function () {
                document.getElementById("overlay").style.display = "none";
            },

            // // Incremental timer
            // secondsCounter: function () {
            //     date = new Date();
            //     date.setSeconds(0, 0);
            //     return setInterval(date.getSeconds(), 1000);
            // },

            // Generate ball repositioning for new turn. Avoids lineal movement (-0.01 to 0.01)
            getRandomFloat: function (min, max) {
                const str = (Math.random() * (max - min) + min).toFixed(3);
                if (parseFloat(str) == 0.000 || parseFloat(str) == 0.001 || parseFloat(str) == -0.001) pongGame.getRandomFloat(min, max)
                else return parseFloat(str);
            },

            // Generate random option
            getRandomOption: function () {
                return res = (Math.random() < 0.5) ? direction.left : direction.right;
            },
        };

        var clock = {
            totalSeconds: 0,

            startTimer: function () {
                if (!this.interval) {
                    var self = this;
                    function pad(val) { return val > 9 ? val : "0" + val; }
                    this.interval = setInterval(function () {
                        self.totalSeconds += 1;
                    }, 1000);
                }
            },

            resetTimer: function () {
                clock.totalSeconds = null;
                clearInterval(this.interval);
                delete this.interval;
            },

            pauseTimer: function () {
                clearInterval(this.interval);
                delete this.interval;
            },

            resumeTimer: function () {
                this.startTimer();
            }
        };

        var pongGame = Object.assign({}, game);

    </script>

</body>

</html>